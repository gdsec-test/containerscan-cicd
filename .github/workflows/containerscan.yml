on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "sceptre/**"
      - ".github/workflows/sceptre.yml"

  pull_request:
    branches: [main]
    paths-ignore:
      - "sceptre/**"
      - ".github/workflows/sceptre.yml"

name: scan container images
env:
  CONTAINER_IMAGE_TWISTCLI: 123456789.dkr.ecr.us-east-1.amazonaws.com/scanner:latest
  CONTAINER_IMAGE_TEST: 123456789.dkr.ecr.us-east-1.amazonaws.com/scanner:latest
  CONTAINER_GOOD_IMAGE_TEST: 123456789.dkr.ecr.us-east-1.amazonaws.com/bad:latest

jobs:
  build-and-scan:
    name: Build and Scan for Vulnerabilities
    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f

    - name: Configure AWS credentials using Cloud Key Based Service Accounts
      uses: aws-actions/configure-aws-credentials@1ed6eed14f0f832cad5830fb357d937c2f20ec67
      with:
        aws-access-key-id: ${{ secrets.DEV_PRIVATE_AWS_SECRET_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.DEV_PRIVATE_AWS_SECRET_TOKEN_VALUE }}
        role-to-assume: ${{ secrets.DEV_PRIVATE_AWS_DEPLOY_ROLE }}
        role-duration-seconds: 3600
        aws-region: us-west-2

    - name: Check AWS Role
      run: aws sts get-caller-identity

    - name: Log into golden image ECR
      run: |
        aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 764525110978.dkr.ecr.us-west-2.amazonaws.com

    - name: Build and tag the image twistcli
      run: docker build -t ${{env.CONTAINER_IMAGE_TWISTCLI}} -t ${{github.sha}} ./docker

    - name: Build and tag the image for test scan
      run: docker build -t ${{env.CONTAINER_IMAGE_TEST}} ./docker

    - name: Scan self image
      run: |
        PR_SHA=${{github.event.pull_request.head.sha}}
        docker run \
        --rm \
        --group-add $(stat -c '%g' /var/run/docker.sock) \
        -v /var/run/docker.sock:/var/run/docker.sock:ro \
        -e AWS_ACCESS_KEY_ID \
        -e AWS_SECRET_ACCESS_KEY \
        -e AWS_SESSION_TOKEN \
        -e AWS_DEFAULT_REGION \
        -e TARGET_URL=https://github.com/${{github.repository}}/actions/runs/${{github.run_id}} \
        -e GITHUB_URL=https://github.com/ \
        -e CONTAINER=${{env.CONTAINER_IMAGE_TEST}} \
        -e PAT=${{github.token}} \
        -e GITHUB_REPO=${{github.repository}} \
        -e COMMIT_SHA=${PR_SHA:-${{github.sha}}} \
        ${{env.CONTAINER_IMAGE_TWISTCLI}}

    - name: Build and tag good image for test scan
      run: cd ./test && docker build -t ${{env.CONTAINER_GOOD_IMAGE_TEST}} . -f good.Dockerfile 

    - name: Scan good image without posting github status
      run: |
        docker run \
        --rm \
        --group-add $(stat -c '%g' /var/run/docker.sock) \
        -v /var/run/docker.sock:/var/run/docker.sock:ro \
        -e AWS_ACCESS_KEY_ID \
        -e AWS_SECRET_ACCESS_KEY \
        -e AWS_SESSION_TOKEN \
        -e AWS_DEFAULT_REGION \
        -e SCANNER_STATUS=nostatus \
        -e CONTAINER=${{env.CONTAINER_GOOD_IMAGE_TEST}} \
        ${{env.CONTAINER_IMAGE_TWISTCLI}}

    - name: Scan good image with JSON output
      run: |
        PR_SHA=${{github.event.pull_request.head.sha}}
        docker run \
        --rm \
        --group-add $(stat -c '%g' /var/run/docker.sock) \
        -v /var/run/docker.sock:/var/run/docker.sock:ro \
        -e AWS_ACCESS_KEY_ID \
        -e AWS_SECRET_ACCESS_KEY \
        -e AWS_SESSION_TOKEN \
        -e AWS_DEFAULT_REGION \
        -e CONTAINER=${{env.CONTAINER_GOOD_IMAGE_TEST}} \
        -e TARGET_URL=https://github.com/${{github.repository}}/actions/runs/${{github.run_id}} \
        -e GITHUB_URL=https://github.com/ \
        -e PAT=${{github.token}} \
        -e GITHUB_REPO=${{github.repository}} \
        -e COMMIT_SHA=${PR_SHA:-${{github.sha}}} \
        -e FORMAT=json \
        ${{env.CONTAINER_IMAGE_TWISTCLI}}